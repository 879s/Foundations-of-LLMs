# TEACH MULTIMODAL LLMS TO COMPREHEND ELECTROCARDIOGRAPHIC IMAGES

*Ruoqi Liu ,Yuelin Bai , Xiang Yue, Ping Zhang* 

*The Ohio State University, Carnegie Mellon University*



## 研究框图

下图给出此文的的整体逻辑框架。首先，对文章进行一句话总结，然后简要介绍研究内容、研究动机、技术动机、解决方案以及优势与潜力，以便读者快速了解文章脉络。


![](https://fastly.jsdelivr.net/gh/bucketio/img19@main/2024/10/31/1730386939104-17a009c5-6cc7-4f42-8690-86034a7ef5b6.png)



## 方法详解

为解决心电图图像解读难题，本文开展了一系列研究。首先**构建了 ECGInstruct 数据集**，其涵盖超百万样本，包含多种任务类型，数据来源广泛且经多种方式处理，图像合成模拟真实情况并增强多样性。接着**训练 PULSE 模型**，基于LLaVA架构，利用 ECGInstruct 训练，使模型能理解分析心电图图像。最后**建立 ECGBench 评估基准**，从现有数据集策划多种任务，确定不同评估指标，用于全面评估模型性能，实验表明 PULSE 在不同数据集和任务上表现优异，具有很强的应用潜力。


### 构建指令微调数据集

##### 整合不同来源的数据

从多个地理区域的不同数据源收集心电图数据，包括德国的 PTB - XL、美国的 MIMIC - IV - ECG、巴西的 CODE - 15% 以及基于 PTB - XL 构建的 ECG - QA。这些多样化的数据源确保了数据的广泛代表性，能够涵盖不同地区人群的心电图特征差异。

##### 设计不同的任务和类型




- **基本特征识别**：例如涉及识别心电图中的心率、节律、心脏轴等基本参数，以及波形形态（如 P 波、QRS 波群、T 波等）和间隔（如 PR 间期、QT 间期等）的特征。问题形式多样，包括封闭式问答（如判断心脏传导系统是否正常）、开放式问答（如描述根据心电图可推断的心脏电传导系统情况）、填空题（如填写心电图的节律、心脏轴和束支传导阻滞情况）和选择题（如从给定选项中选择受基线漂移影响的导联）。
- **心律分析**：涵盖对心律失常、起搏模式等的分析。任务包括识别和分类心电图中的节律异常（如判断是窦性心动过速、心房颤动、心室早搏等哪种心律失常），对多种节律异常同时存在时进行排序（如按对患者血流动力学稳定性的潜在影响排序），以及在特定临床场景下（如急诊医生查看心电图时）确定主要关注的节律问题等，问题类型有开放式、多项选择和填空等形式。
- **形态和病理识别**：主要涉及识别心电图波形中与病理状况相关的特征，如判断是否存在心肌梗死（根据 Q 波、ST 段变化等特征确定梗死位置）、缺血（通过 ST 段和 T 波变化分析）、心包炎等病理情况，以及对 QRS 波群形态变化（如右束支传导阻滞时 V1、V2 导联的特征性波形）与心脏传导模式关系的解释，问题形式包括开放式问答、多项选择和填空等。
- **临床报告生成**：根据心电图图像生成详细的临床报告，描述心电图的各项特征、诊断结论以及可能的临床意义等，问题类型为开放式问答。

![](https://fastly.jsdelivr.net/gh/bucketio/img1@main/2024/10/31/1730387133236-64c52eec-a59e-4c70-a82d-69d91b97b29e.png)

![](https://fastly.jsdelivr.net/gh/bucketio/img16@main/2024/10/31/1730387151519-a930489b-ba36-4d5d-a537-ae3461e7ec71.png)

##### **图像合成与增强**

- **基础图像生成**：生成标准 12 导联心电图图像，其具有黑波形、白背景、红网格线、4x3 布局的特征。

- **失真与噪声添加**：

- 添加模拟纸质磨损的皱纹和折痕。
- 随机旋转图像模拟扫描或打印偏差。
- 改变图像分辨率和背景颜色（如模拟老化或扫描质量差的微黄背景）。
- 添加噪声。
- 调整图像纵横比、整体大小以及心电图在图像中的位置。
- 随机去除网格线以体现不同系统和格式差异。

- **元信息插入**：从相关数据集（如 PTB - XL+）中提取患者人口统计学信息（年龄、性别）和基本心电图特征（心率、轴偏差等）作为元信息随机插入图像头部，增加视觉多样性和上下文信息。

- **导联配置多样化**：采用多种导联配置（如 12x1、6x2 等）丰富模型训练的图像类型。

- **数据集平衡**：合成图像与标准图像比例约为 1:1，帮助模型学习不同质量和特征的心电图图像。

##### 数据合成方式

- **自动数据合成pipeline**：利用 PTB - XL 和 MIMIC - IV - ECG 的临床报告作为初始数据，借助 Llama - 3 - 70B - Instruct 模型进行数据合成。基于专家提供的示例和现实世界场景，生成大量心电图相关指令和响应。对于缺乏全面报告的数据集（如 CODE - 15%），手动构建模板将现有数据转换为指令 - 响应格式。

- **数据评估方式**：使用 Llama 3 模型来评判，根据指令相关性、清晰度、响应的可回答性等评估标准对生成的指令 - 响应对进行评分（0 - 5 分）

### PULSE 模型训练

- **模型架构**： LLaVA，主要由三个核心组件构成。
  - 视觉编码器负责处理心电图图像，将图像信息转换为模型能够理解的特征表示；
  - 大语言模型作为文本解码器，对输入的指令和图像特征进行分析和处理，生成相应的文本回应；
  - 投影层则起到连接视觉编码器和大语言模型的桥梁作用，使两者能够协同工作，实现图像与文本模态的对齐。
- **数据组织与训练**：
  - **数据格式**：图像、指令和输出。指令是与心电图图像相关的查询或任务描述，在数据处理过程中，将图像置于每次对话的开头，作为整个对话的视觉基础，为后续的文本分析提供直观的视觉信息支持。
  - **训练策略**：在训练时，冻结视觉编码器的参数，仅更新投影层和大语言模型的参数。采用自回归训练目标，在训练过程中，会屏蔽属于图像和指令的所有标记

### **ECGBench 评估基准建立**

- **异常检测**：对不同数据集特点选择合适指标，对于多标签数据集（PTB - XL Super、CODE - 15%、CPSC 2018）采用 AUC、 F1 和 HL 损失，对于单标签数据集（ECG - QA、CSN、G12EC）采用 Accurary，从不同角度全面评估模型对异常检测任务的性能。
- **报告生成**：利用 GPT - 4o 作为评判者，从节律、波形和诊断三个关键组件对模型生成的报告进行评估，每个组件 0 - 10 分，最终平均并缩放至 100 分，通过这种方式更细致地评估报告质量，而不是简单依赖传统文本生成指标。
- **MMMU ECG**：以准确率为主要指标，设计基于规则的评估管道，运用正则表达式等技术处理模型的长响应，提取答案选项进行准确匹配，确保评分的一致性和可靠性，对于无法提取有效答案的情况进行随机选择评分，以客观评估模型在该任务中的表现。
- **ECG Arena**：使用 GPT - 4o 作为评估模型，从准确性（模型回应与真实答案在心电图解读和诊断方面的匹配程度）、完整性（模型回应涵盖心电图解读关键方面的全面程度）和指令遵循（模型遵循问题特定指令的程度）三个角度进行评估，每个角度 0 - 10 分，通过平均这三个方面并缩放至 100 分来确定模型在 ECG Arena 任务中的综合表现。

### 实验：
在不同数据集和任务上均达到了最先进水平，显著优于其他模型。在域内数据集方面，如 PTB - XL Super 任务中，PULSE 的 AUC 值高达 82.4，相比最佳专有模型 GPT - 4o 提高了 27%，报告得分提升 11 分，在 ECG - QA 任务中准确率提高 39%；与最佳开源模型相比，在相同任务上 AUC 提升 28%，报告得分增加 12 分，准确率提高 44%。在域外数据集上同样表现出色，在 MMMU ECG 基准测试中，准确率相比 GPT - 4o 提高了 15%

![](https://fastly.jsdelivr.net/gh/bucketio/img17@main/2024/10/31/1730387366776-b8dc6d69-5578-4905-b847-396a3c7ca70c.png)

![](https://fastly.jsdelivr.net/gh/bucketio/img3@main/2024/10/31/1730387398318-3cb87c3f-c72c-476b-8ac6-c5f64af17828.png)


---

- 查看 Arxiv 原文请点击"**阅读原文**" [https://arxiv.org/abs/2410.04749]
- **更多**大模型学习资料，请详见浙大 Daily 实验室 Github 仓库: 
  **https://github.com/ZJU-LLMs/Foundations-of-LLMs**
- 本文编辑：徐文溢，毛玉仁
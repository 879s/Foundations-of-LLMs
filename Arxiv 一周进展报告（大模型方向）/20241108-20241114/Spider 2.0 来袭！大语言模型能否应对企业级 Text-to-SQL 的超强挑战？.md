# Spider 2.0: Evaluating Language Models on Real-World Enterprise Text-to-SQL Workflows

**作者**：*Fangyu Lei, Jixuan Chen等*

**单位**：*University of Hong Kong, Google等*


下图给出此文的整体逻辑框架。首先，对文章进行一句话总结，然后简要介绍研究内容、研究动机、技术动机、解决方案以及优势与潜力，以便读者快速了解文章脉络。

![](https://fastly.jsdelivr.net/gh/bucketio/img11@main/2024/11/17/1731837342120-ae307026-bf7f-489b-bd28-fb33c0836dbf.png)

### Spider 2.0

自动代码生成可以作为人类与数据之间的桥梁，帮助个人使用复杂数据完成困难或单调的任务。现有数据的大部分存储在关系数据库中，SQL作为与这些数据交互的关键接口。在这种情况下，Text-to-SQL是一项重要技术，能够帮助数据分析师执行常规查询、编排数据工作流并实现高级商业智能，从而显著减少重复的人力劳动并减轻程序员的负担。大语言模型在生成代码方面展示了出色的能力，基于GPT-4的方法在经典基准Spider 1.0和Bird上分别达到了91.2%和73.0%的执行准确率。

尽管LLMs在这些数据集上表现出色，但它们通常使用非工业数据库，这些数据库包含少量表和列，具有简单的SQL和问题，无法反映真实世界的复杂性，并忽略了多样化的SQL方言。相比之下，真实世界的数据存储在各种数据库系统中，每个系统都有其独特的SQL方言，引入了广泛的SQL语法和函数。此外，这些企业级应用数据库的特点是大规模模式，包含数千列和复杂的嵌套结构。此外，真实世界的 Text-to-SQL 工作流需要利用项目代码库、外部知识和各种上下文来构建跨多个步骤的复杂SQL查询，完成各种操作，并构建全面的数据工程管道。这包括数据整理以清理和组织数据以进行分析，数据转换以重新构建和增强数据，以及进行数据分析以提取洞察力，从而为决策提供信息并推动战略举措。所有这些复杂性都凸显了需要更现实的企业级基准的迫切需求。

针对当前Text-to-SQL落地应用存在的问题，本文提出了 Sider 2.0，一个反映真实世界数据工作流的基准，涵盖632个真实世界的复杂数据整理、转换和分析任务。Spider 2.0中的数据库来自工业应用（例如Google Analytics和Salesforce），具有大量的表列项（一个数据库平均812列）和复杂的结构，以及TB级数据量。它们涵盖了各种数据库系统，包括本地数据库（例如SQLite和DuckDB）和云数据仓库（例如BigQuery和Snowflake）。这些数据库的复杂SQL方言从技术教程、社区论坛和开源项目中整理而来。平均而言，每个标准SQL查询包含144个Token，并包括高级函数（例如，ST_DISTANCE(x1, x2)测量两点之间的最短距离），显示出显著超过先前基准的复杂性。所有任务都基于项目代码库以及文档和数据库接口，以模拟真实世界的文本到SQL编写场景。

接下来将介绍 Spider 2.0 构造流程。


![](https://fastly.jsdelivr.net/gh/bucketio/img1@main/2024/11/17/1731837389676-50aaee33-2882-461e-923b-d82d88342103.png)

### Spider 2.0 基准构建

八位计算机科学出身的SQL的专家共同参与做数据注释。注释流程包括以下六个步骤：

1) **数据库和SQL收集。** 从云数据仓库（包括BigQuery公共数据、Snowflake市场数据和其他平台）收集各种数据库，以确保它们满足特定标准：每个数据库必须包含超过200列或具有嵌套模式结构。经过过滤后，选择了74个BigQuery、54个Snowflake、30个SQLite、40个DuckDB、10个PostgreSQL和5个ClickHouse数据库。从相应的教程和论坛中，收集了1,021个复杂SQL查询，以及157个来自Fivetran和DBT的数据转换项目。为了满足标准，SQL查询必须包含超过50个Token（按空格分词；作为参考，Bird的平均标记数为30.9）。此外，查询必须来自实际项目或教程，而不是合成示例或极端情况。最终，保留了547个高质量SQL查询和78个DBT项目。

2. **SQL重写以防止数据泄露。** 为了避免污染并确保Spider 2.0评估的可信度，注释者需要重写每个SQL并验证其无错误。重写分为两个层次的复杂性：表面层次和语义层次，如下表所示。84.2%的示例进行了表面层次的重写，而42%进行了语义层次的重写。注释者必须确保重写的SQL执行成功，在可接受的时间内完成，并返回非空结果。85.98%的这些SQL查询使用各种方言中的高级函数，而10.76%的SQL需要使用额外的DBT工具，这些SQL需要整合项目上下文才能书写。


![](https://fastly.jsdelivr.net/gh/bucketio/img18@main/2024/11/17/1731837440128-68cc74dd-d61c-4d21-86fa-630462788716.png)

3) **代码库和上下文设置。** 对于Spider 2.0-lite和Spider 2.0-snow中的每个复杂SQL查询，收集完成任务所需的外部参考文档。由于任务跨越多种数据库类型，收集了SQL方言和外部函数的文档。此外，对于Spider 2.0，保留了SQL相关项目的原始代码库。对于Spider 2.0，除了收集参考文档外，注释者还收集资源，如代码库、数据库接口，以建立每个任务的上下文。

4) **自然语言任务指令注释**。 注释者需要根据步骤3中收集的SQL和上下文编写问题，为不同设置编写两个版本。指令旨在平衡自然性和无歧义性。注释者手动编写指令，使其自然化，避免生硬的描述，消除预期结果中的歧义，并确保所有SQL条件都清晰提及。注释者根据提供的上下文编写任务指令。在初始注释后，验证SQL查询和指令之间的语义等价性，并通过LLMs的帮助进行改写以提高清晰度。

6) **质量控制**。 为了确保基准的质量，每个指令、标准SQL查询和评估脚本至少由三位注释者审查。要求注释者反复审查步骤3）、4），以确保注释的正确性、自然性和无歧义性。因此，45%的示例在第一次验证者中发现了错误。经过第二次验证者的第二轮迭代讨论和修正后，只有5%的示例包含错误。然后修正所有错误并完善所有注释，最终所有示例都被认为是完全注释的。


### 数据集统计

在下表中详细分析了Spider 2.0、Spider 2.0-snow和Spider 2.0-lite的特征，并将它们与其他多个数据集进行了比较。Spider 2.0 的数据集在数据库、SQL和任务场景方面表现出较强的复杂性和现实性。


![](https://fastly.jsdelivr.net/gh/bucketio/img19@main/2024/11/17/1731844483742-94f7b661-e317-4eb2-8abd-5c8c60a5a31b.png)

多样化的数据库系统和SQL方言。 Spider 2.0的基准包含多种数据库系统，包括云数据仓库如BigQuery和Snowflake，本地托管的数据库如Postgres和ClickHouse，以及轻量级系统如SQLite和DuckDB。这种多样性使我们的基准与之前的工作区分开来，涵盖了各种SQL方言。值得注意的是，85.98%的示例需要使用这些方言中的专用函数，每个标准SQL平均使用7.1个特殊函数。

![](https://fastly.jsdelivr.net/gh/bucketio/img16@main/2024/11/17/1731844529053-b55b477b-bb06-4ed8-8314-fb171ba71701.png)

**真实且复杂的数据库模式。** Spider 2.0中的数据库配备了大规模模式，包含广泛的表和列，有效反映了真实世界的企业级环境。如下表所示，这些数据库具有复杂的模式结构（例如，多模式和嵌套模式，分区表），并且动态表每天更新。此外，数据涵盖了广泛的复杂类型、大量数据量和多样化的范围，使其比之前的基准更加多样化。


![](https://fastly.jsdelivr.net/gh/bucketio/img17@main/2024/11/17/1731844561192-803bfb19-c5fe-4c79-94b7-64c9776e77ea.png)

**数据工程管道中的挑战性任务。** 基准中的示例来自实际教程和论坛，涵盖了数据管道中遇到的各种问题，包括数据整理、数据转换和数据分析。这些问题的难度显著超过了之前的SQL相关基准，因为Spider 2.0中的SQL查询包含的列、Token和函数比先前的工作多得多

**包含代码库和文档的真实项目场景。** 数据集中的任务都需要专业访问文档，如外部知识和SQL方言，这需要模型对这些资源有深入的理解。对于Spider 2.0中的每个任务，论文提供了一个代码库上下文来模拟真实工作流。


### 实验结果


1. **实验设置**
   - **评估指标**
     - **成功率（SR）**：用于Spider 2.0，衡量模型成功完成任务实例的比例。例如，在一组100个任务中，模型成功完成了20个，那么成功率为20%。
     - **执行准确率（EX）**：用于Spider 2.0 - lite和Spider 2.0 - snow，通过比较预测SQL查询的执行结果与真实结果来衡量模型生成SQL的准确性。例如，预测的SQL查询执行结果与真实结果完全一致的任务占总任务数的比例。
   - **难度分类**
     - 根据SQL查询的token数量将问题分为易（<80 tokens）、中（80 - 159 tokens）、难（≥160 tokens）三类。例如，一个简单的查询“SELECT * FROM table WHERE id = 1”可能被归为易类，而一个复杂的嵌套查询涉及多个表连接和条件判断可能被归为难类。
   - **模型选择**
     - 实验多种开源（如DeepseekCoder - V2.5、Qwen2.5 - 72B - Instruct、Llama - 3.1 - 405B等）和闭源（如Gemini - Pro - 1.5、Claude3.5 - Sonnet、GPT系列等）语言模型，以全面评估不同类型模型在基准上的表现。
     - 采用多个代码代理框架（如Reflexion、CodeR、AutoEval、Spider - Agent等）和文本到SQL方法（如DIN - SQL、DAIL - SQL、CHESS、SFT CodeS等）进行实验，比较它们在处理企业级文本到SQL任务中的能力。

2. **实验过程**
   - 对于Spider 2.0，模型在给定问题、数据库接口和代码库的情况下，迭代修改代码（SQL/Python），通过执行代码与数据库交互，直到获得最终结果（文本/表格/数据库），然后根据成功率指标评估模型性能。
   - 对于Spider 2.0 - lite和Spider 2.0 - snow，模型根据给定的数据库模式、自然语言问题和辅助文档，生成SQL查询，通过执行SQL查询并根据执行准确率指标评估模型性能。在这个过程中，为了处理复杂数据类型，会提供采样单元格值；对于某些方法，还会进行参考计划、提供oracle函数等操作来辅助模型生成SQL查询。同时，由于评估时从大规模数据库检索值成本高，在处理BigQuery实例时不进行值链接（部分方法）。

3. **实验结果**


![](https://fastly.jsdelivr.net/gh/bucketio/img0@main/2024/11/17/1731844611626-57d285d6-8475-428b-9da4-1189af5a1420.png)


![](https://fastly.jsdelivr.net/gh/bucketio/img5@main/2024/11/17/1731844623159-fefcf8fd-1116-4678-b9a1-1f0c42d0d1cd.png)

   - 现有语言模型在真实世界文本到SQL工作流任务中表现不佳，如o1 - preview模型在Spider 2.0上的成功率最高仅为17.01%，远低于其在以往基准（如Spider 1.0上91.2%的执行准确率）上的表现，这表明即使是先进的语言模型在处理企业级复杂任务时仍有很大提升空间。
   - 现有代码代理框架解决数据库相关编码任务能力有限，例如使用强大的GPT - 4o的CodeR框架在Spider 2.0上的成功率仅为7.91%，而在其他基准（如SWE - Bench）上表现较好，说明当前框架在处理企业级数据库任务时面临挑战，需要专门针对数据库任务进行改进。
   - 当前基于语言模型的方法在处理企业级文本到SQL任务时能力有限，如在Spider 2.0 - lite和Spider 2.0 - snow中，表现最佳的DAIL - SQL + GPT - 4o方法的执行准确率分别仅为5.68%和2.20%，远低于其在Spider 1.0（86.6%）和BIRD（57.4%）数据集上的得分，反映出Spider 2.0基准的复杂性和挑战性。
   
### Spider 2.0 榜单

论文还提出了 Spider 2.0 榜单，所有对 Text-to-SQL 感兴趣的研究人员都可以在该榜单上提交自己的方法。


![](https://fastly.jsdelivr.net/gh/bucketio/img7@main/2024/11/17/1731844659221-7c875bb9-e59e-443b-be9d-85e1de078b0c.png)


---


- 查看 Arxiv 原文链接请点击“**阅读原文**”
  [https://arxiv.org/pdf/2411.07763]
- **更多**模型学习资料，请详见浙大 Daily 实验室 Github 仓库：**https://github.com/ZJU-LLMs/Foundations-of-LLMs**
- 本文编辑：张超 毛玉仁



